<plugin>
    <!-- this Plugin does not have any HTML content -->
    <script>
        // Windy API modules are imported via '@windy/nameOfModule'
        import {map} from '@windy/map';
        var xhttp = new XMLHttpRequest();
        /*
                    This part of code will be executed just once, since
                    plugin remains 'mounted' in a page even after	closing
                */
        console.log('I am being mounted');

        let popup = null;
        let markerLayer = null;

        //	this.onopen method is called when your plugin is being opened
        this.onopen = () => {
            console.log('I am being opened');
            const center = map.getCenter();
            const iconColours = ['BLU', 'WHT', 'GRE', 'YLO1', 'YLO2', 'AMB', 'RED']
            let icons = []
            createIcons = function() {
                for (let i = 0; i < iconColours.length; i++) {
                var Icon = L.icon({
                    iconUrl: 'leaf-green.png';

                    iconSize:     [38, 95], // size of the icon
                    shadowSize:   [50, 64], // size of the shadow
                    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
                    shadowAnchor: [4, 62],  // the same for the shadow
                    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
                });
            }

            let icao_list = ["EGDM","EGYE","EGUB", "EGVN", "EGXC", "EGWC", "EGYD", "EGXE", "EGQS", "EGYM", "EGWU", "EGVO", "EGXP",
            "EGOS", "EGSY", "EGOV", "EGXW","WOTG", "EGXT", "EGOW"];
            let icao_list_string = "";

            for (let i = 0; i < icao_list.length - 1; i++) {
                if (i < icao_list.length) {

                icao_list_string += icao_list[i] + ",";
                }
                else {
                    icao_list_string += icao_list[i];
                }
            }

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    // console.log(xhttp.responseText);

                    let METAR_data = JSON.parse(xhttp.responseText);
                    // console.log(METAR_data["data"][0][0]);
                    console.log(icao_list_string);
                    return METAR_data;

                }
            };
            var web_string = `https://api.checkwx.com/metar/${icao_list_string}/decoded`;
            xhttp.open("GET", web_string, true);
            xhttp.setRequestHeader('X-API-Key', '6b8ce0d9f2ee488a8e5f91ce58');
            xhttp.send();
            let METAR_data = xhttp.responseText;


            /*
                this.ononpen method can be called repeatedly (without your plugin
                being closed before), so make sure, that you will not to subscribe
                to any listener twice
            */
            if (popup) {
                popup.setLatLng(center);
            } else {

                for (markerLayer = L.marker()
                    .setLatLng(center)
                    .addTo(map)
                    .bindPopup("`${METAR_data['data'][0][0]}`")
                    .openPopup();

                console.log(METAR_data['data'][0][0]);
                console.log(icao_list_string);
            }
        };

        /*
            this.onclose method is called when your plugin is being closed

            Unsubscribe from all your listeners, and remove all your
            stuff from a map
        */
        this.onclose = () => {
            console.log('I am being closed');
            if (popup) {
                map.removeLayer(popup);
                popup = null;
            }
        };
    </script>
</plugin>
